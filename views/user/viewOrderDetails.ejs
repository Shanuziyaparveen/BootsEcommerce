<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #2c2c54; /* Dark purple background */
      color: #fff; /* White text */
      font-family: Arial, sans-serif;
    }
    .container {
      margin-top: 20px;
      background-color: #403d58; /* Slightly lighter purple for cards */
      padding: 20px;
      border-radius: 10px;
    }
    .card {
      background-color: #5a5566;
      border: none;
    }
    .card-header, .card-footer {
      background-color: #4e4a59;
      border: none;
    }
    .btn-primary {
      background-color: #6c5ce7;
      border-color: #6c5ce7;
    }
    .btn-primary:hover {
      background-color: #5a4bcf;
    }
    .badge-info {
      background-color: #00cec9;
    }
    .disabled-btn {
      background-color: #888;
      pointer-events: none;
    }
    .timeline {
      list-style: none;
      padding: 0;
    }
    .timeline li {
      margin-bottom: 15px;
      position: relative;
    }
    .timeline li:before {
      content: '';
      position: absolute;
      left: -5px;
      top: 0;
      width: 10px;
      height: 10px;
      background: #6c5ce7;
      border-radius: 50%;
    }
    .timeline li span {
      margin-left: 20px;
    }
    .a{
      text-decoration: none;

    }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="text-center">Order Details</h3>
    <hr>


    <h5>Order ID: <%= order.orderId %></h5>
    <p><strong>Status:</strong> <span class="badge badge-info"><%= order.status %></span></p>
    <hr>

    <!-- Timeline for Order Status -->
    <h5>Order Progress</h5>
    <ul class="timeline">
      <li>
        <span>Ordered: <%= new Date(order.dates.ordered).toLocaleDateString() %></span>
      </li>
      <% if (order.dates.shipped) { %>
        <li>
          <span>Shipped: <%= new Date(order.dates.shipped).toLocaleDateString() %></span>
        </li>
      <% } %>
      <% if (order.dates.delivered) { %>
        <li>
          <span>Delivered: <%= new Date(order.dates.delivered).toLocaleDateString() %></span>
        </li>
      <% } %>
    </ul>
    <hr>

    <!-- Address Section -->
   <!-- Address Section -->
<h5>Delivery Address</h5>
<p>
  <strong>Name:</strong> <%= address.name %><br>
  
  <strong>City:</strong> <%= address.city %><br>
  <strong>State:</strong> <%= address.state %><br>
  <strong>Pincode:</strong> <%= address.pincode %><br>
  <strong>Phone:</strong> <%= address.phone %>
</p>

    <hr>

    <!-- Ordered Items Section -->
    <h5>Ordered Items</h5>
    <% order.orderedItems.forEach((item) => { %>
      <div class="card mb-3">
        <div class="card-body d-flex justify-content-between">
          <img 
          src="/uploads/re-image/<%= item.product.productImage[0] %>" 
          alt="<%= item.name %>" 
          style="width: 100px; height: auto; object-fit: cover;">
        
          <div>
           <a href="/" > <p><strong>Product:</strong> <%= item.product.productName %></p></a>
            <p><strong>Quantity:</strong> <%= item.quantity %></p>
          </div>
          <div>
            <p><strong>Price:</strong> 
              <!-- Regular price with strikethrough -->
              <span style="text-decoration: line-through; color: #888;">₹<%= item.product.regularPrice %></span> 
              <!-- Sale price -->
              <span style="color: #ff7f50; font-weight: bold;">₹<%= item.product.salePrice %></span>
            </p>
              <!-- Display product status -->
              <% if (item.productStatus === 'Cancelled' || order.status === 'Cancelled' || order.status === 'Shipped' || order.status === 'Delivered' || order.status === 'Return Request' || order.status === 'Returned') { %>
                <p style="color: red; font-weight: bold;">Status: <%= item.productStatus %></p>
                <button class="btn btn-secondary cancel-btn" disabled>Cancelled/Non-Cancellable</button>
              <% } else { %>
                <button 
                  class="btn btn-danger cancel-btn" 
                  onclick="cancelProduct('<%= item.product._id %>', '<%= order._id %>')">
                  Cancel Item
                </button>
              <% } %>
          </div>
        </div>
      </div>
    <% }) %>
    <hr>

    <!-- Total Price -->
    <h5>Order Total: ₹<%= order.totalPrice %></h5>
    <hr>

    <!-- Action Buttons -->
    <% if (success) { %>
      <div class="alert alert-success" role="alert">
        <%= success %>
      </div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-danger" role="alert">
        <%= error %>
      </div>
    <% } %>
   <!-- Action Buttons -->
<div class="text-right">
  <% 
    const allCancelled = order.orderedItems.length === 1 && order.orderedItems[0].productStatus === 'Cancelled';
  %>
  <% if (allCancelled) { %>
    <!-- Show "Order Cancelled" if only one item exists and it's cancelled -->
    <button class="btn btn-secondary disabled-btn" disabled>Order Cancelled</button>
  <% } else if (order.status === 'Pending' || order.status === 'Processing' || order.status === 'Shipped') { %>
    <!-- Allow cancelling the entire order if other items are available -->
    <a href="/cancelOrder?id=<%= order._id %>" class="btn btn-danger">Cancel Order</a>
  <% } else if (order.status === 'Delivered') { %>
    <!-- Option for returning the order -->
    <a href="/returnOrder?id=<%= order._id %>" class="btn btn-warning">Return Order</a>
  <% } else { %>
    <!-- Disable other actions if no valid status applies -->
    <button class="btn btn-secondary disabled-btn" disabled>No Actions Available</button>
  <% } %>
</div>

  </div>
</body>
<script>
 function cancelProduct(productId, orderId) {
  if (confirm("Are you sure you want to cancel this product?")) {
    // Send a request to the backend with product and order details
    fetch(`/cancel-product/${productId}?orderId=${orderId}`, {
      method: "GET",
    })
      .then((response) => response.json()) // Parse the JSON response
      .then((data) => {
        if (data.success) {
          alert("Product canceled successfully!");
          window.location.reload(); // Refresh the page to reflect changes
        } else {
          alert("Failed to cancel the product. Please try again.");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred. Please try again later.");
      });
  }
}

</script>
</html>
